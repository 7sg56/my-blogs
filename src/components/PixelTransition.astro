<div
    id="pixel-transition"
    class="fixed inset-0 z-[100] grid grid-cols-10 grid-rows-10 pointer-events-none"
>
    <!-- Grid items will be generated by script -->
</div>

<style>
    #pixel-transition div {
        background-color: black;
        opacity: 1; /* Default to opaque to prevent flash on swap */
        transition: opacity 0.05s ease-in-out;
    }
</style>

<script>
    function setupPixelGrid() {
        const container = document.getElementById("pixel-transition");
        if (!container) return;

        container.innerHTML = "";
        for (let i = 0; i < 100; i++) {
            const div = document.createElement("div");
            container.appendChild(div);
        }

        // Animate Out on load/swap
        animateGridOut();
    }

    function animateGridOut() {
        const container = document.getElementById("pixel-transition");
        if (!container) return;

        const blocks = Array.from(container.children) as HTMLElement[];
        const shuffled = [...blocks].sort(() => Math.random() - 0.5);

        shuffled.forEach((block, i) => {
            setTimeout(() => {
                block.style.opacity = "0";
            }, i * 5);
        });
    }

    // Initial setup
    setupPixelGrid();

    // Re-setup after swap
    document.addEventListener("astro:after-swap", setupPixelGrid);

    // Animate IN before leaving
    document.addEventListener("astro:before-preparation", (event) => {
        const originalLoader = event.loader;

        event.loader = async () => {
            const container = document.getElementById("pixel-transition");
            if (container) {
                const blocks = Array.from(container.children) as HTMLElement[];
                // Reset to 0 just in case, but they should be 0 from previous animation
                // Actually they are 0.

                const shuffled = [...blocks].sort(() => Math.random() - 0.5);

                await Promise.all(
                    shuffled.map((block, i) => {
                        return new Promise<void>((resolve) => {
                            setTimeout(() => {
                                block.style.opacity = "1";
                                resolve();
                            }, i * 5);
                        });
                    }),
                );

                await new Promise((r) => setTimeout(r, 100));
            }
            await originalLoader();
        };
    });
</script>
